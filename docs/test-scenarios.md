# Magic Switch - テストシナリオ

## 1. テスト計画

### 1.1 テストの目的
Magic Switch アプリケーションが要件定義書に記載された全機能要件・非機能要件を満たすことを検証し、品質を保証する。

### 1.2 テストスコープ
- **対象**: Magic Switch v1.0 の全機能
- **対象外**: Magic Mouse 対応、Windows/Linux 対応、クラウド経由リモート切り替え、iPad/iPhone 切り替え

### 1.3 テストレベル

| レベル | 目的 | ツール/手法 |
|--------|------|-------------|
| ユニットテスト | 個々のモジュール・関数の正常動作を検証 | XCTest / Swift Testing |
| 統合テスト | モジュール間連携の正常動作を検証 | XCTest |
| E2E テスト | ユーザー操作フローの正常動作を検証 | XCUITest |
| 受入テスト | ユーザーストーリーの受入条件を検証 | 手動テスト |

### 1.4 テスト環境要件

| 項目 | 要件 |
|------|------|
| Mac 台数 | 最低 2台（推奨 3台） |
| OS | macOS 13 Ventura 以降（macOS 13, 14, 15 で検証） |
| アーキテクチャ | Apple Silicon (arm64) および Intel (x86_64) |
| デバイス | Magic Keyboard（Lightning/USB-C 各1台以上）、Magic Trackpad（1台以上） |
| ネットワーク | 同一ローカルネットワーク（Wi-Fi / 有線 LAN） |
| ツール | blueutil インストール済み |

---

## 2. ユニットテストシナリオ

### 2.1 Bluetooth デバイス検出・管理

#### UT-001: Magic Keyboard の検出
- **前提条件**: Magic Keyboard がシステムにペアリング済み
- **テスト手順**: デバイス検出モジュールを実行し、ペアリング済みデバイス一覧を取得する
- **期待結果**: Magic Keyboard がデバイス名、モデル、MAC アドレスとともに一覧に含まれる
- **優先度**: High

#### UT-002: Magic Trackpad の検出
- **前提条件**: Magic Trackpad がシステムにペアリング済み
- **テスト手順**: デバイス検出モジュールを実行し、ペアリング済みデバイス一覧を取得する
- **期待結果**: Magic Trackpad がデバイス名、モデル、MAC アドレスとともに一覧に含まれる
- **優先度**: High

#### UT-003: 非対応デバイスのフィルタリング
- **前提条件**: Magic Mouse、AirPods 等の非対応デバイスがペアリング済み
- **テスト手順**: デバイス検出モジュールを実行し、デバイス一覧を取得する
- **期待結果**: Magic Keyboard / Magic Trackpad のみがフィルタされ、非対応デバイスは一覧に含まれない
- **優先度**: Medium

#### UT-004: 未ペアリングデバイスの処理
- **前提条件**: 対象デバイスが未ペアリング状態
- **テスト手順**: デバイス検出モジュールを実行する
- **期待結果**: 未ペアリングデバイスは検出一覧に含まれず、手動ペアリングガイダンスのフラグが返される
- **優先度**: Medium

#### UT-005: デバイスモデル判定（全世代対応）
- **前提条件**: 各世代の Magic Keyboard / Trackpad の Bluetooth プロファイル情報をモックで用意
- **テスト手順**: 各モデル情報をデバイス判定関数に渡す
- **期待結果**: Lightning モデル、USB-C モデル、Touch ID モデル、Numeric Keypad モデルがすべて正しく識別される
- **優先度**: High

### 2.2 ネットワーク通信

#### UT-006: Bonjour サービスの公開
- **前提条件**: ネットワークモジュールが初期化済み
- **テスト手順**: Bonjour サービス公開関数を呼び出す
- **期待結果**: mDNS サービスが正常に公開され、サービスタイプとポート番号が正しい
- **優先度**: High

#### UT-007: Bonjour サービスの検出
- **前提条件**: 別の Mac で Magic Switch の Bonjour サービスが公開されている（モック可）
- **テスト手順**: サービス検出関数を呼び出す
- **期待結果**: 公開中のサービスが検出され、ホスト名・IPアドレスが取得できる
- **優先度**: High

#### UT-008: 切り替えコマンドの送信
- **前提条件**: 通信先の Mac のアドレスが判明している（モック可）
- **テスト手順**: 切り替えコマンド送信関数にデバイス MAC アドレスと操作種別（pair）を渡す
- **期待結果**: コマンドが正しいフォーマットで送信され、応答を受信できる
- **優先度**: High

#### UT-009: 切り替えコマンドの受信・処理
- **前提条件**: 通信リスナーが起動済み
- **テスト手順**: テスト用の切り替えコマンドを送信する
- **期待結果**: コマンドが正しくパースされ、指定されたデバイス操作が実行される
- **優先度**: High

#### UT-010: TLS 暗号化通信の検証
- **前提条件**: TLS 設定済みの通信モジュール
- **テスト手順**: 通信を開始し、パケットキャプチャでペイロードを確認する
- **期待結果**: 通信内容が暗号化されており、平文では読み取れない
- **優先度**: High

#### UT-011: 認証されていない Mac からのリクエスト拒否
- **前提条件**: 未認証の Mac からの接続をシミュレート
- **テスト手順**: 認証情報なしで切り替えコマンドを送信する
- **期待結果**: リクエストが拒否され、エラーレスポンスが返される
- **優先度**: High

### 2.3 設定管理

#### UT-012: 接続先 Mac の登録
- **前提条件**: 設定ストアが初期化済み
- **テスト手順**: Mac の識別子とラベル名を指定して登録関数を呼び出す
- **期待結果**: 登録が成功し、設定ストアに保存される
- **優先度**: High

#### UT-013: 接続先 Mac の登録上限（3台）
- **前提条件**: すでに 3台の Mac が登録済み
- **テスト手順**: 4台目の Mac を登録しようとする
- **期待結果**: 登録が拒否され、上限エラーが返される
- **優先度**: High

#### UT-014: 接続先 Mac の編集
- **前提条件**: 1台以上の Mac が登録済み
- **テスト手順**: 登録済み Mac のラベルを変更する
- **期待結果**: ラベルが更新され、設定ストアに反映される
- **優先度**: Medium

#### UT-015: 接続先 Mac の削除
- **前提条件**: 1台以上の Mac が登録済み
- **テスト手順**: 登録済み Mac を削除する
- **期待結果**: 削除が成功し、設定ストアから除去される
- **優先度**: Medium

#### UT-016: 設定データのローカル保存
- **前提条件**: 設定変更が行われた
- **テスト手順**: 設定保存関数を呼び出し、保存先ファイルを確認する
- **期待結果**: 設定データがローカルファイルに正しく保存される。外部送信は行われない
- **優先度**: High

#### UT-017: キーボードショートカットの保存・読み込み
- **前提条件**: 設定ストアが初期化済み
- **テスト手順**: カスタムショートカット（例：⌃⌥⌘1）を保存し、再読み込みする
- **期待結果**: ショートカット設定が正しく永続化され、再読み込み後も同じ値が取得できる
- **優先度**: Medium

### 2.4 デバイス切り替えロジック

#### UT-018: 単一デバイスの切り替えフロー
- **前提条件**: デバイス情報と切り替え先 Mac 情報が設定済み（モック）
- **テスト手順**: 切り替え関数に1台のデバイスと切り替え先 Mac を渡す
- **期待結果**: unpair → (ネットワーク経由で切り替え先に通知) → pair の順序で処理が実行される
- **優先度**: High

#### UT-019: 複数デバイスの一括切り替えフロー
- **前提条件**: Keyboard + Trackpad の2台のデバイス情報が設定済み（モック）
- **テスト手順**: 一括切り替え関数に2台のデバイスと切り替え先 Mac を渡す
- **期待結果**: 2台のデバイスが並行して切り替え処理され、すべて完了後に成功が返される
- **優先度**: High

#### UT-020: 切り替えリトライロジック
- **前提条件**: 切り替え処理が1回目に失敗するようにモック設定
- **テスト手順**: 切り替え関数を実行する
- **期待結果**: 最大3回のリトライが行われ、成功した時点で完了する
- **優先度**: High

#### UT-021: 切り替えタイムアウト処理
- **前提条件**: 切り替え先 Mac が応答しないようにモック設定
- **テスト手順**: 切り替え関数を実行する
- **期待結果**: 15秒後にタイムアウトし、エラーが返される
- **優先度**: High

#### UT-022: 優先順位に基づくデバイス紐付け
- **前提条件**: デバイスに対して複数の接続先 Mac が優先順位付きで設定済み
- **テスト手順**: 優先順位取得関数を呼び出す
- **期待結果**: 設定された優先順位順に接続先が返される
- **優先度**: Medium

### 2.5 ログ出力

#### UT-023: ログファイル出力
- **前提条件**: ログモジュールが初期化済み
- **テスト手順**: 各ログレベル（DEBUG / INFO / WARN / ERROR）でログを出力する
- **期待結果**: `~/Library/Logs/MagicSwitch/` にログファイルが生成され、ログレベルに応じたメッセージが記録される
- **優先度**: Medium

#### UT-024: ログレベルフィルタリング
- **前提条件**: ログレベルを INFO に設定
- **テスト手順**: DEBUG レベルと INFO レベルのログを出力する
- **期待結果**: DEBUG ログはファイルに記録されず、INFO 以上のログのみ記録される
- **優先度**: Low

---

## 3. 統合テストシナリオ

### 3.1 Bluetooth + ネットワーク連携

#### IT-001: ローカルデバイス切断 → リモート接続の連携
- **前提条件**: 2台の Mac が同一ネットワーク上にあり、Magic Switch がインストール済み。Mac A に Magic Keyboard が接続中
- **テスト手順**:
  1. Mac A で切り替え先として Mac B を選択
  2. Mac A 側の unpair 処理を確認
  3. Mac B 側の pair 処理を確認
- **期待結果**: Mac A での unpair 完了後に Mac B で pair が実行され、Mac B に Keyboard が接続される
- **優先度**: High

#### IT-002: Bonjour 検出 → Mac 登録の連携
- **前提条件**: 2台の Mac が同一ネットワーク上にあり、Magic Switch がインストール済み
- **テスト手順**:
  1. Mac A で Bonjour 検出を実行
  2. 検出された Mac B を接続先として登録
- **期待結果**: Mac B が候補として表示され、登録操作が正常に完了する
- **優先度**: High

#### IT-003: ネットワーク切断時の切り替え失敗と通知
- **前提条件**: 2台の Mac が接続中の状態で、ネットワークを切断
- **テスト手順**: ネットワーク切断状態で切り替えを試行する
- **期待結果**: タイムアウト後にエラー通知が表示され、元の接続状態が維持される
- **優先度**: High

### 3.2 UI + ロジック連携

#### IT-004: メニューバードロップダウンから切り替え実行
- **前提条件**: Magic Switch が起動中。デバイスと接続先が設定済み
- **テスト手順**:
  1. メニューバーアイコンをクリック
  2. ドロップダウンから切り替え先 Mac を選択
- **期待結果**: 切り替えロジックが呼び出され、インジケータが表示され、完了後に通知が表示される
- **優先度**: High

#### IT-005: キーボードショートカットから切り替え実行
- **前提条件**: グローバルショートカットが設定済み（例：⌃⌥⌘1）
- **テスト手順**: 設定済みのショートカットキーを押下する
- **期待結果**: 切り替えロジックが呼び出され、切り替えが実行される
- **優先度**: High

#### IT-006: バッテリー残量のリアルタイム更新
- **前提条件**: Magic Keyboard が接続中
- **テスト手順**: メニューバーのドロップダウンを開く
- **期待結果**: 現在のバッテリー残量が%表示される
- **優先度**: Medium

### 3.3 設定変更の反映

#### IT-007: 接続先 Mac 追加後のメニュー反映
- **前提条件**: Magic Switch が起動中
- **テスト手順**:
  1. 設定画面で新しい接続先 Mac を追加
  2. メニューバーのドロップダウンを確認
- **期待結果**: 追加した Mac がドロップダウンの切り替え先に即座に反映される
- **優先度**: Medium

#### IT-008: ショートカット変更後の即時反映
- **前提条件**: Magic Switch が起動中、既存のショートカットが設定済み
- **テスト手順**:
  1. 設定画面でショートカットを変更
  2. 新しいショートカットを押下
- **期待結果**: 変更後のショートカットで切り替えが実行される。旧ショートカットは無効になる
- **優先度**: Medium

#### IT-009: ログイン時自動起動設定の反映
- **前提条件**: Magic Switch が起動中
- **テスト手順**:
  1. 設定画面で「ログイン時の自動起動」を ON にする
  2. Mac を再起動する
- **期待結果**: 再起動後、Magic Switch が自動的に起動し、メニューバーに表示される
- **優先度**: Medium

---

## 4. 機能テストシナリオ（シナリオテスト）

### 4.1 デバイス検出（FR-001）

#### FT-001: ペアリング済み Magic Keyboard の検出
- **前提条件**: Magic Keyboard がシステムにペアリング済み
- **テスト手順**:
  1. Magic Switch を起動する
  2. デバイス一覧画面を開く
- **期待結果**: Magic Keyboard がデバイス名、モデル、MAC アドレスとともに表示される
- **優先度**: High

#### FT-002: ペアリング済み Magic Trackpad の検出
- **前提条件**: Magic Trackpad がシステムにペアリング済み
- **テスト手順**:
  1. Magic Switch を起動する
  2. デバイス一覧画面を開く
- **期待結果**: Magic Trackpad がデバイス名、モデル、MAC アドレスとともに表示される
- **優先度**: High

#### FT-003: 複数デバイスの同時検出
- **前提条件**: Magic Keyboard と Magic Trackpad の両方がペアリング済み
- **テスト手順**:
  1. Magic Switch を起動する
  2. デバイス一覧画面を開く
- **期待結果**: 両方のデバイスが一覧に表示される
- **優先度**: High

#### FT-004: Touch ID 付き Magic Keyboard の検出
- **前提条件**: Magic Keyboard with Touch ID がシステムにペアリング済み
- **テスト手順**:
  1. Magic Switch を起動する
  2. デバイス一覧画面を開く
- **期待結果**: Touch ID 付きモデルとして正しく識別・表示される
- **優先度**: Medium

### 4.2 接続先 Mac 登録（FR-002）

#### FT-005: Mac の登録（1台目）
- **前提条件**: 接続先 Mac が 0台の状態
- **テスト手順**:
  1. 設定画面を開く
  2. 「接続先 Mac を追加」を選択
  3. Mac の情報を入力し、ラベル（例：「仕事用 MacBook Pro」）を設定
  4. 保存する
- **期待結果**: Mac が登録され、一覧に表示される
- **優先度**: High

#### FT-006: Mac の登録（3台目 = 上限）
- **前提条件**: すでに 2台の Mac が登録済み
- **テスト手順**:
  1. 3台目の Mac を登録する
- **期待結果**: 登録が成功し、3台すべてが一覧に表示される
- **優先度**: High

#### FT-007: Mac の登録上限超過（4台目の拒否）
- **前提条件**: すでに 3台の Mac が登録済み
- **テスト手順**:
  1. 4台目の Mac を登録しようとする
- **期待結果**: 登録が拒否され、上限に達している旨のメッセージが表示される
- **優先度**: High

#### FT-008: 登録済み Mac のラベル編集
- **前提条件**: 1台以上の Mac が登録済み
- **テスト手順**:
  1. 設定画面で登録済み Mac を選択
  2. ラベルを「個人用 Mac mini」に変更し保存
- **期待結果**: ラベルが更新され、メニューバーのドロップダウンにも反映される
- **優先度**: Medium

#### FT-009: 登録済み Mac の削除
- **前提条件**: 2台以上の Mac が登録済み
- **テスト手順**:
  1. 設定画面で登録済み Mac を選択し削除
- **期待結果**: Mac が削除され、一覧・ドロップダウンから除去される
- **優先度**: Medium

### 4.3 ワンクリック切り替え（FR-004）

#### FT-010: メニューバーからの単一デバイス切り替え
- **前提条件**: Magic Keyboard が Mac A に接続中。Mac B が登録済み
- **テスト手順**:
  1. メニューバーアイコンをクリック
  2. ドロップダウンから Mac B を選択
- **期待結果**:
  - 切り替え開始時にインジケータ（スピナー）が表示される
  - Mac A から Keyboard が切断される
  - Mac B に Keyboard が接続される
  - 切り替え完了通知が表示される
- **優先度**: High

#### FT-011: メニューバーからの一括切り替え（Keyboard + Trackpad）
- **前提条件**: Magic Keyboard と Magic Trackpad が Mac A に接続中。Mac B が登録済み
- **テスト手順**:
  1. メニューバーアイコンをクリック
  2. 一括切り替えで Mac B を選択
- **期待結果**:
  - 両デバイスが Mac A から切断される
  - 両デバイスが Mac B に接続される
  - 切り替え完了まで 15秒以内
  - 切り替え完了通知が表示される
- **優先度**: High

### 4.4 キーボードショートカット切り替え（FR-005）

#### FT-012: デフォルトショートカットでの切り替え
- **前提条件**: デフォルトのキーボードショートカットが設定済み。デバイスが Mac A に接続中
- **テスト手順**:
  1. Mac B に割り当てられたデフォルトショートカットを押下する
- **期待結果**: 切り替えが自動的に開始され、Mac B にデバイスが接続される
- **優先度**: High

#### FT-013: カスタムショートカットの設定と実行
- **前提条件**: Magic Switch が起動中
- **テスト手順**:
  1. 設定画面でショートカットを ⌃⌥⌘2 に変更
  2. ⌃⌥⌘2 を押下する
- **期待結果**: カスタムショートカットで切り替えが実行される
- **優先度**: Medium

#### FT-014: Keyboard 切り替え中のフォールバック
- **前提条件**: Magic Keyboard が切り替え対象。Trackpad が接続中
- **テスト手順**:
  1. ショートカットで Keyboard の切り替えを開始
  2. 切り替え中に Trackpad でメニューバーを操作
- **期待結果**: Keyboard 切り替え中でも Trackpad でのメニュー操作が可能
- **優先度**: Medium

### 4.5 切り替えフィードバック（FR-006）

#### FT-015: 切り替え開始時のインジケータ表示
- **前提条件**: デバイスが接続中
- **テスト手順**: 切り替えを開始する
- **期待結果**: メニューバーアイコンがアニメーション表示（スピナー）になる
- **優先度**: Medium

#### FT-016: 切り替え完了通知
- **前提条件**: 通知設定が ON
- **テスト手順**: 切り替えを実行して完了を待つ
- **期待結果**: macOS 通知センターに切り替え完了の通知が表示される
- **優先度**: Medium

#### FT-017: 切り替え失敗時のエラー通知
- **前提条件**: 切り替え先 Mac がオフライン
- **テスト手順**: オフラインの Mac への切り替えを試行する
- **期待結果**: エラー通知にエラー内容と対処方法（「元の Mac に戻す」ボタン、手動接続ガイダンス等）が表示される
- **優先度**: High

### 4.6 接続状態表示（FR-007）

#### FT-018: 接続中のアイコン表示
- **前提条件**: デバイスが Mac に接続中
- **テスト手順**: メニューバーを確認する
- **期待結果**: アイコンがアクティブ表示になっている
- **優先度**: Medium

#### FT-019: 未接続時のアイコン表示
- **前提条件**: すべてのデバイスが未接続状態
- **テスト手順**: メニューバーを確認する
- **期待結果**: アイコンがグレーアウト表示になっている
- **優先度**: Medium

#### FT-020: ドロップダウンのデバイス接続先表示
- **前提条件**: デバイスが Mac A に接続中
- **テスト手順**: メニューバーのドロップダウンを開く
- **期待結果**: 各デバイスの横に現在の接続先 Mac 名が表示される
- **優先度**: Medium

### 4.7 バッテリー表示（FR-008）

#### FT-021: バッテリー残量のパーセント表示
- **前提条件**: Magic Keyboard が接続中
- **テスト手順**: メニューバーのドロップダウンを開く
- **期待結果**: バッテリー残量が % で表示される
- **優先度**: Medium

#### FT-022: バッテリー低下通知（20% 以下）
- **前提条件**: Magic Keyboard のバッテリーが 20% 以下
- **テスト手順**: バッテリー残量が 20% 以下になるまで使用する（またはモック）
- **期待結果**: macOS 通知センターにバッテリー低下の通知が表示される
- **優先度**: Medium

#### FT-023: バッテリー低下閾値のカスタマイズ
- **前提条件**: Magic Switch が起動中
- **テスト手順**:
  1. 設定画面でバッテリー低下通知の閾値を 30% に変更
  2. バッテリーが 30% 以下になるまで待つ（またはモック）
- **期待結果**: 30% 以下の時点で通知が表示される
- **優先度**: Low

### 4.8 メニューバー常駐（FR-009）

#### FT-024: メニューバー表示・Dock 非表示
- **前提条件**: Magic Switch がインストール済み
- **テスト手順**:
  1. Magic Switch を起動する
  2. メニューバーと Dock を確認する
- **期待結果**: メニューバーにアイコンが表示される。Dock にはアイコンが表示されない
- **優先度**: High

#### FT-025: メニューバーアイコンクリックでドロップダウン表示
- **前提条件**: Magic Switch が起動中
- **テスト手順**: メニューバーアイコンをクリックする
- **期待結果**: ドロップダウンメニューが表示され、デバイス情報と接続先が確認できる
- **優先度**: High

### 4.9 設定画面（FR-010）

#### FT-026: 設定画面の表示
- **前提条件**: Magic Switch が起動中
- **テスト手順**: ドロップダウンメニューから設定を開く
- **期待結果**: 設定画面が表示され、全設定項目（デバイス管理、接続先 Mac、ショートカット、自動起動、通知、バッテリー閾値）が確認できる
- **優先度**: Medium

#### FT-027: 通知設定の ON/OFF
- **前提条件**: 通知設定が ON の状態
- **テスト手順**:
  1. 通知設定を OFF にする
  2. 切り替えを実行する
- **期待結果**: 切り替え完了通知が表示されない
- **優先度**: Low

### 4.10 初期セットアップウィザード（FR-011）

#### FT-028: ウィザードの初回起動時表示
- **前提条件**: Magic Switch を初めて起動する（設定ファイルなし）
- **テスト手順**: Magic Switch を起動する
- **期待結果**: セットアップウィザードが自動的に表示される
- **優先度**: High

#### FT-029: 権限許可のガイド
- **前提条件**: ウィザードのステップ1
- **テスト手順**: ウィザードの権限許可画面を進める
- **期待結果**: Bluetooth、Accessibility、Local Network の各権限について許可を求めるガイドが表示される
- **優先度**: High

#### FT-030: ウィザードでのデバイス自動検出
- **前提条件**: ウィザードのステップ2。Magic デバイスがペアリング済み
- **テスト手順**: ウィザードのデバイス選択画面に進む
- **期待結果**: ペアリング済みの Magic Keyboard / Trackpad が自動検出され、選択可能な状態で表示される
- **優先度**: High

#### FT-031: ウィザードでの接続先 Mac 登録
- **前提条件**: ウィザードのステップ3。同一ネットワーク上に別の Mac がある
- **テスト手順**: ウィザードの接続先 Mac 登録画面で Mac を登録する
- **期待結果**: ネットワーク上の Mac が自動検出され、登録が完了する
- **優先度**: High

#### FT-032: ウィザードのスキップ（ショートカット設定）
- **前提条件**: ウィザードのステップ4
- **テスト手順**: ショートカット設定をスキップする
- **期待結果**: ショートカットを設定せずにウィザードが完了する
- **優先度**: Low

### 4.11 Mac 間通信（FR-012, FR-013）

#### FT-033: 同一ネットワーク上の Mac の自動検出
- **前提条件**: 2台の Mac が同一ネットワーク上にあり、両方に Magic Switch がインストール済み
- **テスト手順**:
  1. Mac A で Magic Switch を起動
  2. 接続先 Mac 一覧を確認
- **期待結果**: Mac B が自動検出され、候補として表示される
- **優先度**: High

#### FT-034: 初回接続時の相互認証
- **前提条件**: Mac A と Mac B が初めて接続する
- **テスト手順**:
  1. Mac A から Mac B への切り替えを初めて試行する
- **期待結果**: ペアリングコード等による相互認証プロセスが実行される
- **優先度**: High

#### FT-035: 異なるネットワークの Mac が非検出
- **前提条件**: Mac B が異なるネットワークに接続されている
- **テスト手順**: Mac A で接続先 Mac の自動検出を実行する
- **期待結果**: Mac B が候補に表示されない
- **優先度**: Medium

---

## 5. 非機能テストシナリオ

### 5.1 パフォーマンステスト

#### NFT-001: 単一デバイスの切り替え時間（10秒以内）
- **前提条件**: Magic Keyboard が Mac A に接続中。Mac B が登録済み。同一ネットワーク
- **テスト手順**:
  1. タイマーを開始
  2. Mac B への切り替えを実行
  3. 切り替え完了時にタイマーを停止
- **期待結果**: 切り替え完了時間が 10秒以内
- **優先度**: High

#### NFT-002: 2台同時切り替え時間（15秒以内）
- **前提条件**: Magic Keyboard + Trackpad が Mac A に接続中。Mac B が登録済み
- **テスト手順**:
  1. タイマーを開始
  2. 一括切り替えを実行
  3. 両デバイスの切り替え完了時にタイマーを停止
- **期待結果**: 切り替え完了時間が 15秒以内
- **優先度**: High

#### NFT-003: 連続切り替えのパフォーマンス
- **前提条件**: Mac A と Mac B が登録済み
- **テスト手順**: Mac A → Mac B → Mac A → Mac B の切り替えを5回連続で実行する
- **期待結果**: 各回の切り替え時間が規定時間以内であり、パフォーマンスの劣化がない
- **優先度**: Medium

### 5.2 リソース使用量テスト

#### NFT-004: アイドル時メモリ使用量（50MB 以下）
- **前提条件**: Magic Switch が起動中。切り替え操作をしていない状態
- **テスト手順**: Activity Monitor でメモリ使用量を計測する
- **期待結果**: メモリ使用量が 50MB 以下
- **優先度**: High

#### NFT-005: アイドル時 CPU 使用率（1% 以下）
- **前提条件**: Magic Switch が起動中。切り替え操作をしていない状態
- **テスト手順**: Activity Monitor で CPU 使用率を 1分間計測する
- **期待結果**: 平均 CPU 使用率が 1% 以下
- **優先度**: High

#### NFT-006: 長時間稼働時のメモリリーク確認
- **前提条件**: Magic Switch が起動中
- **テスト手順**: 24時間稼働後のメモリ使用量を計測する
- **期待結果**: 起動時と比較してメモリ使用量が大幅に増加していない（+10MB 以内）
- **優先度**: Medium

### 5.3 セキュリティテスト

#### NFT-007: Mac 間通信の暗号化確認
- **前提条件**: 2台の Mac 間で切り替え通信が可能な状態
- **テスト手順**:
  1. Wireshark 等でネットワークパケットをキャプチャ
  2. 切り替えコマンドを送信
  3. キャプチャしたパケットを分析
- **期待結果**: 通信内容が TLS で暗号化されており、平文で読み取れない
- **優先度**: High

#### NFT-008: 未認証 Mac からの切り替えリクエスト拒否
- **前提条件**: 登録されていない Mac からリクエストを送信
- **テスト手順**: 未認証の Mac から切り替えコマンドを送信する
- **期待結果**: リクエストが拒否され、対象 Mac 側にログが記録される
- **優先度**: High

#### NFT-009: 初回ペアリングコードによる相互認証
- **前提条件**: 2台の Mac が初めて接続する
- **テスト手順**: 初回接続を試行し、認証プロセスを確認する
- **期待結果**: ペアリングコードが両方の Mac に表示され、一致確認後に接続が確立される
- **優先度**: High

#### NFT-010: 設定データの外部送信がないことの確認
- **前提条件**: Magic Switch が起動中
- **テスト手順**:
  1. ネットワークモニタで送信パケットを監視
  2. 通常操作を行う
- **期待結果**: ローカルネットワーク以外（インターネット上の外部サーバー）へのデータ送信がない
- **優先度**: High

### 5.4 信頼性テスト

#### NFT-011: ネットワーク切断時の自動再接続
- **前提条件**: 2台の Mac が接続中
- **テスト手順**:
  1. ネットワークを一時的に切断（Wi-Fi OFF）
  2. 30秒後にネットワークを再接続
- **期待結果**: 自動的に再接続が試行され、Mac 間通信が復旧する
- **優先度**: High

#### NFT-012: 切り替え失敗時のリトライ（最大3回）
- **前提条件**: 切り替え先 Mac の Bluetooth が一時的に不安定な状態
- **テスト手順**: 切り替えを実行する
- **期待結果**: 失敗時に最大3回のリトライが自動的に行われる。成功した場合は完了通知、3回とも失敗した場合はエラー通知が表示される
- **優先度**: High

#### NFT-013: 切り替え先 Mac 応答なし時のタイムアウト（15秒）
- **前提条件**: 切り替え先 Mac がシャットダウンされている
- **テスト手順**: オフラインの Mac への切り替えを試行する
- **期待結果**: 15秒後にタイムアウトし、エラーメッセージが表示される
- **優先度**: High

---

## 6. 異常系・エッジケーステスト

#### EC-001: ネットワーク切断中の切り替え試行
- **前提条件**: Mac 間のネットワークが切断されている
- **テスト手順**: 切り替えを試行する
- **期待結果**: 即座にエラーが表示され、「ネットワーク接続を確認してください」のメッセージが表示される。元の接続状態は維持される
- **優先度**: High

#### EC-002: 切り替え先 Mac がオフラインの場合
- **前提条件**: 切り替え先 Mac がシャットダウンまたはスリープ状態
- **テスト手順**: オフラインの Mac への切り替えを試行する
- **期待結果**: タイムアウト（15秒）後にエラーが表示される。「元の Mac に戻す」ボタンと手動接続ガイダンスが表示される
- **優先度**: High

#### EC-003: デバイスのバッテリーが切れた場合
- **前提条件**: Magic Keyboard のバッテリーが 0%（電源 OFF）
- **テスト手順**:
  1. バッテリー切れのデバイスの状態表示を確認
  2. 切り替えを試行する
- **期待結果**: デバイスが「未接続」として表示される。切り替え操作が適切にハンドリングされ、エラーメッセージが表示される
- **優先度**: Medium

#### EC-004: 同時に複数の切り替え要求が発生した場合
- **前提条件**: デバイスが Mac A に接続中
- **テスト手順**: Mac B への切り替えを開始した直後に、Mac C への切り替えを要求する
- **期待結果**: 先行する切り替え処理が進行中である旨が表示され、新しい要求はキューイングまたは拒否される
- **優先度**: Medium

#### EC-005: 切り替え中にアプリが終了した場合
- **前提条件**: 切り替え処理が進行中
- **テスト手順**: 切り替え中に Magic Switch を強制終了する
- **期待結果**: 次回起動時にデバイスの接続状態が確認され、必要に応じてリカバリ操作（元の Mac に戻す/手動接続ガイダンス）が提供される
- **優先度**: High

#### EC-006: 切り替え中に切り替え元 Mac がスリープした場合
- **前提条件**: Mac A からの切り替え処理が進行中
- **テスト手順**: 切り替え処理中に Mac A のスリープを発生させる
- **期待結果**: Mac B 側で切り替え処理が完了するか、タイムアウト後にリカバリが実行される
- **優先度**: Medium

#### EC-007: Bluetooth が無効の状態で起動
- **前提条件**: Mac の Bluetooth が OFF
- **テスト手順**: Magic Switch を起動する
- **期待結果**: 「Bluetooth を有効にしてください」のメッセージが表示される
- **優先度**: Medium

#### EC-008: 必要な権限が付与されていない状態で操作
- **前提条件**: Accessibility 権限が未許可
- **テスト手順**: キーボードショートカットで切り替えを試行する
- **期待結果**: 権限が必要である旨のメッセージが表示され、システム設定への案内が提供される
- **優先度**: Medium

#### EC-009: Magic Switch が切り替え先 Mac に未インストールの場合
- **前提条件**: Mac B に Magic Switch がインストールされていない
- **テスト手順**: Mac B への切り替えを試行する
- **期待結果**: Mac B が検出されない、またはエラーメッセージが表示される。Magic Switch のインストールを案内する
- **優先度**: Medium

#### EC-010: 同じデバイスに対する操作の競合
- **前提条件**: 別のユーザーが同じデバイスの接続操作を行っている
- **テスト手順**: 2台の Mac から同じ Keyboard に対して同時に接続を試行する
- **期待結果**: 一方の操作が成功し、他方はエラーとなる。デバイスが不整合状態にならない
- **優先度**: Medium

---

## 7. ユーザビリティテスト

#### UX-001: セットアップウィザードの完走テスト
- **前提条件**: 新規インストール直後のユーザー
- **テスト手順**:
  1. 初回起動からウィザードに従って操作
  2. 各ステップの所要時間を計測
- **期待結果**: 技術的知識がないユーザーでも 5分以内にセットアップを完了できる。各ステップの説明が明確である
- **優先度**: Medium

#### UX-002: メニューバー操作の直感性
- **前提条件**: セットアップ完了済み
- **テスト手順**:
  1. メニューバーアイコンをクリック
  2. ドロップダウンの情報の視認性を確認
  3. 切り替え操作の手順を確認
- **期待結果**: 2クリック以内で切り替えが開始できる。現在の接続状態が一目で分かる
- **優先度**: Medium

#### UX-003: エラーメッセージの明確さ
- **前提条件**: 各種エラー状態を再現
- **テスト手順**:
  1. ネットワーク切断、デバイス未接続、タイムアウト等の各エラーを発生させる
  2. 表示されるエラーメッセージを確認
- **期待結果**: 各エラーメッセージが以下を含む：何が起きたか、なぜ起きたか、ユーザーが取るべきアクション
- **優先度**: Medium

#### UX-004: 設定画面の操作性
- **前提条件**: Magic Switch が起動中
- **テスト手順**:
  1. 各設定項目を変更する
  2. 変更の反映を確認
- **期待結果**: 設定変更が直感的に行え、変更が即座に反映される。設定項目のラベルが明確である
- **優先度**: Low

---

## 8. ビルド・配布テスト

#### DT-001: Homebrew Cask インストール
- **前提条件**: Homebrew がインストール済み。Magic Switch 未インストール
- **テスト手順**:
  1. `brew install --cask magic-switch` を実行
- **期待結果**: インストールが正常に完了し、`/Applications/Magic Switch.app` が配置される
- **優先度**: High

#### DT-002: インストール後の初回起動
- **前提条件**: DT-001 でインストール完了済み
- **テスト手順**:
  1. Magic Switch.app を起動する
- **期待結果**: Gatekeeper にブロックされず起動する。セットアップウィザードが表示される
- **優先度**: High

#### DT-003: コード署名と公証の検証
- **前提条件**: ビルド済みの .app バンドル
- **テスト手順**:
  1. `codesign --verify --deep --strict Magic\ Switch.app` を実行
  2. `spctl --assess --type execute Magic\ Switch.app` を実行
- **期待結果**: コード署名が有効。公証が通過済み。Hardened Runtime が有効
- **優先度**: High

#### DT-004: アップデートテスト
- **前提条件**: 旧バージョンの Magic Switch がインストール済み
- **テスト手順**:
  1. `brew upgrade --cask magic-switch` を実行
- **期待結果**: 新バージョンがインストールされ、設定データが引き継がれる
- **優先度**: High

#### DT-005: アンインストールテスト
- **前提条件**: Magic Switch がインストール済み
- **テスト手順**:
  1. `brew uninstall --cask magic-switch` を実行
- **期待結果**: アプリケーションが削除される。設定ファイル・ログファイルの残留状態が適切である
- **優先度**: Medium

#### DT-006: Apple Silicon (arm64) での動作確認
- **前提条件**: Apple Silicon Mac
- **テスト手順**: Magic Switch をインストールし、主要機能を実行する
- **期待結果**: ネイティブで動作し、全機能が正常に動作する
- **優先度**: High

#### DT-007: Intel (x86_64) での動作確認
- **前提条件**: Intel Mac
- **テスト手順**: Magic Switch をインストールし、主要機能を実行する
- **期待結果**: 全機能が正常に動作する
- **優先度**: High

#### DT-008: macOS バージョン別動作確認
- **前提条件**: macOS 13 Ventura、macOS 14 Sonoma、macOS 15 それぞれの環境
- **テスト手順**: 各 OS バージョンで Magic Switch をインストールし、主要機能を実行する
- **期待結果**: macOS 13 以降の各バージョンで全機能が正常に動作する
- **優先度**: High

---

## 9. 受入テスト基準

### 9.1 US-001: 業務用と個人用 Mac の切り替え

#### AT-001: メニューバーからの一括切り替え
- **前提条件**: 業務用 MacBook Pro（Mac A）に Magic Keyboard と Magic Trackpad が接続中。個人用 Mac mini（Mac B）が登録済み
- **テスト手順**:
  1. メニューバーから「個人用 Mac mini」を選択する
- **期待結果**:
  - [x] Keyboard と Trackpad が同時に Mac B に切り替わる
  - [x] 切り替え完了まで 15秒以内
  - [x] 切り替え完了の通知が表示される
- **優先度**: High

### 9.2 US-002: キーボードショートカットでの高速切り替え

#### AT-002: カスタムショートカットでの切り替え
- **前提条件**: グローバルショートカット ⌃⌥⌘2 が Mac B に割り当て済み
- **テスト手順**:
  1. ⌃⌥⌘2 を押下する
- **期待結果**:
  - [x] カスタマイズ可能なグローバルショートカットが動作する
  - [x] ショートカット押下後、切り替えが自動的に開始される
- **優先度**: High

#### AT-003: Keyboard 切り替え中のフォールバック操作
- **前提条件**: Magic Keyboard が切り替え対象
- **テスト手順**:
  1. ショートカットで Keyboard の切り替えを開始
  2. 切り替え中に Trackpad またはメニューバーからの操作を試行
- **期待結果**:
  - [x] Keyboard 切り替え中でも Trackpad またはメニューバーからの操作がフォールバックとして機能する
- **優先度**: Medium

### 9.3 US-003: 初回セットアップ

#### AT-004: セットアップウィザードの完了
- **前提条件**: Magic Switch を初めて起動。Magic デバイスがペアリング済み。同一ネットワーク上に別の Mac がある
- **テスト手順**:
  1. Magic Switch を初回起動する
  2. ウィザードに従って設定を完了する
- **期待結果**:
  - [x] ウィザードが必要な権限（Bluetooth、Accessibility、Local Network）の許可をガイドする
  - [x] ペアリング済みの Magic デバイスが自動検出される
  - [x] 接続先 Mac を登録できる（同一ネットワーク上の Mac を自動検出）
- **優先度**: High

### 9.4 US-004: バッテリー残量の確認

#### AT-005: バッテリー残量表示と低下通知
- **前提条件**: Magic Keyboard と Magic Trackpad が接続中
- **テスト手順**:
  1. メニューバーのドロップダウンを開く
  2. バッテリー残量が 20% 以下になるまで待つ（またはモック）
- **期待結果**:
  - [x] メニューバーのドロップダウンにバッテリー残量が % 表示される
  - [x] 20% 以下で通知が表示される
- **優先度**: Medium

### 9.5 US-005: 切り替え失敗時のリカバリ

#### AT-006: 切り替え失敗時のリカバリ操作
- **前提条件**: 切り替え先 Mac がオフラインの状態
- **テスト手順**:
  1. オフラインの Mac への切り替えを試行する
  2. エラー通知を確認する
  3. 「元の Mac に戻す」ボタンをクリックする
- **期待結果**:
  - [x] エラー通知に「元の Mac に戻す」ボタンが表示される
  - [x] 手動接続のガイダンスが表示される（システム設定の Bluetooth を開くリンク等）
  - [x] 「元の Mac に戻す」ボタンで元の接続状態に復旧できる
- **優先度**: High

---

## テストサマリー

| カテゴリ | テスト数 | High | Medium | Low |
|----------|---------|------|--------|-----|
| ユニットテスト (UT) | 24 | 15 | 7 | 2 |
| 統合テスト (IT) | 9 | 4 | 5 | 0 |
| 機能テスト (FT) | 35 | 16 | 16 | 3 |
| 非機能テスト (NFT) | 13 | 9 | 3 | 1 |
| 異常系・エッジケース (EC) | 10 | 3 | 7 | 0 |
| ユーザビリティ (UX) | 4 | 0 | 3 | 1 |
| ビルド・配布 (DT) | 8 | 6 | 1 | 1 |
| 受入テスト (AT) | 6 | 4 | 2 | 0 |
| **合計** | **109** | **57** | **44** | **8** |

---

## 改訂履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2026-02-23 | 1.0 | 初版作成 |
