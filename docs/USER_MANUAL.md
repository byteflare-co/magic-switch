# Magic Switch ユーザーマニュアル

## 目次

1. [はじめに](#1-はじめに)
2. [必要なもの](#2-必要なもの)
3. [インストール](#3-インストール)
4. [初回セットアップ](#4-初回セットアップ)
5. [日常の使い方](#5-日常の使い方)
6. [切り替えの仕組み（詳細）](#6-切り替えの仕組み詳細)
7. [設定](#7-設定)
8. [トラブルシューティング](#8-トラブルシューティング)
9. [アンインストール](#9-アンインストール)

---

## 1. はじめに

### Magic Switch とは

Magic Switch は macOS のメニューバーに常駐する軽量なアプリケーションです。Apple Magic Keyboard や Magic Trackpad を、2台の Mac 間でワンクリックで切り替えることができます。

通常、Bluetooth デバイスを別の Mac に接続し直すには、システム設定を開いてペアリングをやり直す必要があります。Magic Switch を使えば、メニューバーから1回クリックするだけで、デバイスの切断・再ペアリング・再接続までを自動で行います。

### 動作の仕組み

Magic Switch は以下の流れでデバイスの切り替えを行います。

**準備段階**

1. 2台の Mac それぞれに Magic Switch をインストールする
2. 両方の Mac を同じ WiFi ネットワークに接続する
3. Magic Switch が Bonjour（ローカルネットワーク検出技術）を使い、もう一方の Mac を自動的に検出する

**切り替え時（デバイスが接続中の Mac から操作する場合）**

1. 現在の Mac で Bluetooth デバイスを remove（解除）する
2. 解除完了をポーリングで確認する（最大5回）
3. もう一方の Mac に「CONNECT_ALL」コマンドを送信する
4. もう一方の Mac がデバイスをペアリングし接続する
5. 完了レスポンスを受信し、成功を通知する

**切り替え時（デバイスが切断中の Mac から操作する場合）**

1. もう一方の Mac に「UNREGISTER_ALL」コマンドを送信する
2. もう一方の Mac がデバイスを remove（解除）する
3. 現在の Mac でデバイスをペアリングし接続する
4. 成功を通知する

Magic Switch は [Blue Switch](https://github.com/nicola02nb/Blue-Switch) と互換性のあるプロトコルを実装しているため、相手側の Mac で Blue Switch を使っている場合でも切り替えが可能です。

---

## 2. 必要なもの

Magic Switch を利用するには、以下が必要です。

- **Mac 2台**: macOS 13（Ventura）以降を搭載していること
- **同じ WiFi ネットワーク**: 2台の Mac が同じローカルネットワークに接続されていること（Bonjour による自動検出に必要）
- **Apple Magic デバイス**: 以下のいずれか、または両方
  - Magic Keyboard
  - Magic Trackpad

---

## 3. インストール

### Homebrew でインストールする（推奨）

ターミナルで以下のコマンドを実行します。

```bash
brew tap byteflare-co/tap
brew install --cask magic-switch
```

または1行で実行します。

```bash
brew tap byteflare-co/tap && brew install --cask magic-switch
```

### 手動でインストールする

[GitHub Releases](https://github.com/byteflare-co/magic-switch/releases) ページから最新版の `.dmg` ファイルをダウンロードし、`Magic Switch.app` を `/Applications` フォルダにドラッグ＆ドロップします。

### 重要: 両方の Mac にインストールが必要

Magic Switch は2台の Mac の間でネットワーク通信を行い、デバイスの切り替えを連携します。そのため、**切り替え先の Mac にも Magic Switch がインストールされ、起動している必要があります**。

---

## 4. 初回セットアップ

Magic Switch を初めて起動すると、セットアップウィザードが自動で表示されます。画面上部のステップインジケーターに「権限」「デバイス」「接続先」「完了」の4つのステップが表示されます。

**以下の手順を両方の Mac で行ってください。**

### Step 1: 権限の設定

Magic Switch が正常に動作するためには、以下の権限が必要です。

- **Bluetooth**: Magic デバイスの検出・接続・切断に必要です。macOS のダイアログが表示されたら「許可」を選択してください。許可されていない場合は、「設定を開く」ボタンからシステム設定の「プライバシーとセキュリティ」 > 「Bluetooth」に移動し、Magic Switch を許可してください。
- **ローカルネットワーク**: もう一方の Mac との通信（Bonjour による検出、切り替えコマンドの送受信）に必要です。macOS のダイアログが表示されたら「許可」を選択してください。

両方の権限が「許可済み」と表示されたら、「次へ」をクリックします。

権限のステータスが更新されない場合は、「権限を再確認」ボタンをクリックしてください。

### Step 2: デバイスの選択

この Mac に現在 Bluetooth 接続されている Magic デバイス（Magic Keyboard、Magic Trackpad）が一覧表示されます。

- デバイスが自動的に検出され、デフォルトで全てのデバイスが選択されます
- 切り替え対象から外したいデバイスがある場合は、タップして選択を解除できます
- デバイスが表示されない場合は、「再検出」ボタンをクリックしてください
- 少なくとも1つのデバイスを選択している必要があります

デバイスを選択したら「次へ」をクリックします。

### Step 3: 接続先 Mac の登録

切り替え先の Mac を登録します。

- 「ネットワーク上の Mac」セクションに、同じネットワーク上で Magic Switch が起動している Mac が自動的に表示されます
- 表示された Mac の横にある「追加」ボタンをクリックして登録します
- 登録された Mac は「登録済み」セクションに表示されます
- 登録を取り消す場合は、赤いマイナスボタンをクリックします
- Mac が見つからない場合は、更新ボタン（円形矢印アイコン）をクリックして再検出してください
- 最大3台まで登録可能です
- 少なくとも1台の Mac を登録する必要があります

登録が完了したら「次へ」をクリックします。

### Step 4: 完了

「セットアップ完了」の画面が表示されます。「完了」ボタンをクリックするとウィザードが閉じ、メニューバーからデバイスの切り替えが行えるようになります。

セットアップ完了後は「ログイン時に自動起動」が有効になります。

---

## 5. 日常の使い方

### メニューバーからの操作

1. **メニューバーのキーボードアイコンをクリック**します。ポップオーバー（小さなパネル）が表示されます。

2. ポップオーバーには以下の情報が表示されます。
   - **「接続デバイス」セクション**: 現在この Mac に接続されている Magic デバイスの一覧です。デバイス名、接続状態（接続中 / 未接続）、バッテリー残量が表示されます。
   - **「切り替え先」セクション**: 登録済みの Mac の一覧です。Mac 名、オンライン / オフライン状態が表示されます。

3. 切り替え先の Mac がオンラインの場合、Mac 名の横に「切替」ボタンが表示されます。**「切替」ボタンをクリック**すると切り替えが開始されます。

4. 切り替え中はスピナー（回転インジケーター）が表示されます。切り替えが完了すると、ポップオーバー下部にバナーが表示されます。
   - 成功時: 緑色のバナーで「(Mac名) に切り替えました」と表示されます
   - 失敗時: 赤色のバナーで「切り替え失敗: (理由)」と表示されます
   - バナーは約3秒後に自動的に消えます

### メニューバーアイコンの状態

メニューバーのアイコンはアプリの状態に応じて変化します。

- **塗りつぶしキーボードアイコン**: デバイスが接続されている通常状態
- **線画キーボードアイコン**: デバイスが接続されていない状態
- **省略記号付きキーボードアイコン**: 切り替え処理中

### キーボードショートカットで切り替える

メニューバーを操作しなくても、キーボードショートカットで直接切り替えることができます。ショートカットの設定方法は「7. 設定」の「ショートカットタブ」を参照してください。

### 設定画面を開く

ポップオーバーの右上にある歯車アイコンをクリックするか、メニューバーのキーボードアイコンを右クリックして「設定...」を選択します。

### アプリを終了する

ポップオーバー下部の「終了」ボタンをクリックするか、メニューバーのキーボードアイコンを右クリックして「終了」を選択します。

---

## 6. 切り替えの仕組み（詳細）

Magic Switch はデバイスの接続状態に応じて、3つの異なる動作を行います。

### パターン 1: 全デバイスが接続中の場合

この Mac にデバイスが接続されている状態で、もう一方の Mac に切り替える場合です。

1. **ローカルで remove**: この Mac から全ての Magic デバイスの Bluetooth 接続を解除する
2. **切断確認**: デバイスの切断が完了するまでポーリングで確認する（最大5回、0.5秒間隔）
3. **CONNECT_ALL 送信**: 切り替え先の Mac に「CONNECT_ALL」コマンドをネットワーク経由で送信する
4. **相手側でペアリング+接続**: 切り替え先の Mac がデバイスをペアリングし、Bluetooth 接続する
5. **結果受信**: 切り替え先の Mac から成功/失敗のレスポンスを受信する（タイムアウト: 15秒）

### パターン 2: 全デバイスが切断中の場合

デバイスがもう一方の Mac に接続されている状態で、この Mac に引き込む場合です。

1. **UNREGISTER_ALL 送信**: もう一方の Mac に「UNREGISTER_ALL」コマンドをネットワーク経由で送信する
2. **相手側で remove**: もう一方の Mac がデバイスの Bluetooth 接続を解除する
3. **結果受信**: もう一方の Mac から成功レスポンスを受信する（タイムアウト: 15秒）
4. **ローカルでペアリング+接続**: この Mac でデバイスをペアリングし、Bluetooth 接続する

### パターン 3: 一部のデバイスのみ接続中の場合

一部の Magic デバイスだけが接続されている不整合な状態では、切り替えは実行されません。

- 警告通知が表示されます
- 全てのデバイスの接続状態を揃えてから再度お試しください（例: 接続されていないデバイスの電源を入れ直す）

### リトライ機能

デバイスの解除やペアリングは、失敗時に自動的にリトライされます。デフォルトでは最大3回まで試行し、リトライ間隔は指数関数的に増加します（1秒、2秒、4秒...、最大10秒）。

---

## 7. 設定

### 設定画面の開き方

以下のいずれかの方法で設定画面を開きます。

- メニューバーのキーボードアイコンを**左クリック**してポップオーバーを開き、右上の**歯車アイコン**をクリック
- メニューバーのキーボードアイコンを**右クリック**して「**設定...**」を選択

### 一般タブ

アプリケーションの基本設定を行います。

- **ログイン時に自動起動**: Mac 起動時に Magic Switch を自動で起動するかどうかを設定します
- **通知を表示**: 切り替え成功/失敗時にシステム通知を表示するかどうかを設定します
- **バッテリー低下通知**: デバイスのバッテリー残量が指定した閾値（10% / 15% / 20% / 25% / 30%）を下回ったときに通知します
- **ログレベル**: アプリのログ出力レベルを設定します（DEBUG / INFO / WARN / ERROR）。通常は INFO のままで問題ありません

### デバイスタブ

検出された Magic デバイスの一覧を確認できます。

- デバイス名、接続状態、バッテリー残量が表示されます
- 更新ボタン（円形矢印アイコン）をクリックすると、デバイスを再検出します

### 接続先タブ

切り替え先の Mac の登録・管理を行います。

- **登録済み Mac**: 現在登録されている Mac の一覧です。不要な Mac は削除できます
- **ネットワーク上の Mac**: 同じネットワーク上で検出された Mac が表示されます。「追加」ボタンで登録できます
- **「+」ボタン**: Mac を手動で追加する場合に使用します（Mac の名前を入力）
- 最大3台まで登録可能です

### ショートカットタブ

各ホストへの切り替えにキーボードショートカットを割り当てることができます。

- **ホスト 1 に切り替え**: 登録済みの1番目の Mac に切り替えるショートカット
- **ホスト 2 に切り替え**: 登録済みの2番目の Mac に切り替えるショートカット
- **ホスト 3 に切り替え**: 登録済みの3番目の Mac に切り替えるショートカット

ショートカットの入力欄をクリックし、割り当てたいキーの組み合わせを押すと設定されます。

### 情報タブ

アプリのバージョン情報が表示されます。

---

## 8. トラブルシューティング

### デバイスが検出されない

- **Bluetooth がオンになっていることを確認してください**。システム設定 > Bluetooth で確認できます。
- **Magic デバイスの電源が入っているか確認してください**。Magic Keyboard / Trackpad のスイッチがオンになっていることを確認します。
- **デバイスがこの Mac に接続されているか確認してください**。システム設定 > Bluetooth に表示されていることを確認します。
- **Magic Switch に Bluetooth 権限が許可されていることを確認してください**。システム設定 > プライバシーとセキュリティ > Bluetooth で、Magic Switch が許可されていることを確認します。
- セットアップウィザードの「再検出」ボタン、または設定画面のデバイスタブの更新ボタンをクリックしてみてください。

### 相手の Mac が見つからない

- **両方の Mac が同じ WiFi ネットワークに接続されているか確認してください**。
- **相手の Mac でも Magic Switch が起動しているか確認してください**。Magic Switch がメニューバーに表示されている必要があります。
- **ファイアウォールの設定を確認してください**。ファイアウォールが有効な場合、Magic Switch の通信がブロックされている可能性があります。システム設定 > ネットワーク > ファイアウォール で、Magic Switch の受信接続を許可してください。
- **ローカルネットワーク権限が許可されていることを確認してください**。システム設定 > プライバシーとセキュリティ > ローカルネットワーク で、Magic Switch が許可されていることを確認します。
- 設定画面の接続先タブ、またはセットアップウィザードの更新ボタンをクリックして再検出してみてください。

### 切り替えに失敗する

- **相手の Mac がオンラインであることを確認してください**。ポップオーバーで切り替え先の Mac のステータスが「オンライン」（緑色のドット）になっていることを確認します。
- **一部のデバイスのみ接続中の状態になっていないか確認してください**。全てのデバイスが接続中、または全てが切断中の状態である必要があります。一部だけ接続中の場合は、接続されていないデバイスの電源を入れ直してください。
- **タイムアウトの場合**: 切り替え処理には最大15秒のタイムアウトが設定されています。ネットワークの遅延や相手 Mac の応答が遅い場合、タイムアウトすることがあります。少し時間をおいて再度お試しください。
- **ログを確認してください**。詳細なログは以下のパスに保存されています。
  ```
  ~/Library/Logs/MagicSwitch/
  ```

### 「壊れているため開けません」「開発元を検証できません」と表示される

macOS の Gatekeeper によりアプリの実行がブロックされる場合があります。以下のコマンドをターミナルで実行してください。

```bash
xattr -cr /Applications/Magic\ Switch.app
```

その後、再度アプリを開いてください。

---

## 9. アンインストール

### Homebrew でインストールした場合

ターミナルで以下のコマンドを実行します。

```bash
brew uninstall --cask magic-switch
```

### 手動でインストールした場合

`/Applications/Magic Switch.app` をゴミ箱に移動します。

### 設定ファイルの削除

アンインストール後、設定ファイルとログを完全に削除する場合は、以下のディレクトリを手動で削除してください。

```bash
rm -rf ~/Library/Application\ Support/MagicSwitch/
rm -rf ~/Library/Logs/MagicSwitch/
```
