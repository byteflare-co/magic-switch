# Magic Switch - 要件定義書

## 1. プロダクト概要

### 1.1 アプリケーション名
**Magic Switch**

### 1.2 目的
Apple Magic Keyboard および Magic Trackpad を、複数の Mac 間でワンクリックまたはキーボードショートカットで切り替えられる macOS メニューバーアプリケーション。

### 1.3 解決する課題
現在、Apple Magic Keyboard / Magic Trackpad の接続先 Mac を切り替えるには、以下の手間のかかる手順が必要である：

1. Lightning / USB-C ケーブルで別の Mac に物理接続する
2. または、システム設定 > Bluetooth から手動でペアリングし直す

この作業は1日に何度も発生する場合があり（例：業務用 Mac と個人用 Mac の切り替え）、生産性を大きく損なう。Logicool 製マウスのように、ボタンひとつで接続先を切り替える体験を実現する。

### 1.4 ターゲットユーザー
- 複数の Mac を所有・使用しているユーザー
- 業務用と個人用など、複数の Mac を日常的に切り替えて使用するユーザー
- Apple Magic Keyboard / Magic Trackpad を使用しているユーザー
- デスク上のケーブルを減らし、シンプルな環境を好むユーザー

---

## 2. 機能要件

### 2.1 デバイス管理

#### FR-001: Bluetooth デバイスの検出・一覧表示
- システムにペアリング済みの Magic Keyboard / Magic Trackpad を自動検出し、一覧表示する
- 対応デバイス：
  - Magic Keyboard（全世代：Lightning / USB-C モデル）
  - Magic Keyboard with Touch ID
  - Magic Keyboard with Touch ID and Numeric Keypad
  - Magic Trackpad（全世代：Lightning / USB-C モデル）
- デバイス名、モデル、MAC アドレスを表示する
- 未ペアリングのデバイスについては、初回のみシステム設定での手動ペアリングをガイドする

#### FR-002: 接続先 Mac の登録・管理
- 接続先 Mac を最大 **3台** まで登録できる
- 各 Mac にはユーザーが任意の名前（ラベル）を付けられる（例：「仕事用 MacBook Pro」「個人用 Mac mini」）
- 登録情報として各 Mac の識別子（ホスト名または独自ID）を保持する
- 登録済み Mac の編集・削除が可能

#### FR-003: デバイスと接続先の紐付け
- 各 Bluetooth デバイスに対して、切り替え先となる Mac のリストを紐付けられる
- デバイスごとに接続先の優先順位を設定可能

### 2.2 接続切り替え

#### FR-004: ワンクリック切り替え
- メニューバーのドロップダウンから、接続先 Mac を選択するだけで切り替えを実行できる
- 切り替えフローは以下の通り：
  1. 現在の Mac から対象デバイスを切断（unpair / disconnect）
  2. 切り替え先の Mac で対象デバイスに接続（pair / connect）
- 複数デバイス（例：Keyboard + Trackpad）を同時に切り替える「一括切り替え」機能を提供する

#### FR-005: キーボードショートカットでの切り替え
- グローバルキーボードショートカットで切り替えを実行できる
- デフォルトショートカットを提供し、ユーザーがカスタマイズ可能とする
- 接続先 Mac ごとにショートカットを割り当て可能（例：Mac1 = ⌃⌥⌘1、Mac2 = ⌃⌥⌘2）

#### FR-006: 切り替え時のフィードバック
- 切り替え開始時にインジケータ（スピナー等）を表示する
- 切り替え完了時に通知（macOS 通知センター）で結果を表示する
- 切り替え失敗時にはエラー内容と対処方法を表示する

### 2.3 状態表示

#### FR-007: 現在の接続状態表示
- メニューバーアイコンで現在の接続状態を視覚的に表示する
  - 接続中：アイコンがアクティブ表示
  - 未接続：アイコンがグレーアウト
  - 切り替え中：アイコンがアニメーション表示
- ドロップダウンメニューに各デバイスの接続先 Mac を表示する

#### FR-008: バッテリー残量表示
- 接続中の Magic Keyboard / Magic Trackpad のバッテリー残量をメニューバーまたはドロップダウンに表示する
- バッテリー残量が低下した場合（20% 以下）に通知を表示する

### 2.4 UI/UX

#### FR-009: メニューバー常駐アプリ
- macOS メニューバーに常駐するアプリケーションとして動作する
- Dock にはアイコンを表示しない（LSUIElement = true）
- メニューバーアイコンをクリックするとドロップダウンメニューを表示する

#### FR-010: 設定画面
- 以下の設定項目を提供する：
  - デバイス管理（登録・編集・削除）
  - 接続先 Mac の管理
  - キーボードショートカットの設定
  - ログイン時の自動起動 ON/OFF
  - 通知設定 ON/OFF
  - バッテリー低下通知の閾値設定

#### FR-011: 初期セットアップウィザード
- 初回起動時にセットアップウィザードを表示する
- 以下の手順をガイドする：
  1. 必要な権限（Bluetooth、Accessibility）の許可
  2. 対象デバイスの選択
  3. 接続先 Mac の登録
  4. ショートカットの設定（任意）

### 2.5 ネットワーク連携

#### FR-012: Mac 間の通信
- 切り替えを実現するため、すべての対象 Mac に Magic Switch がインストールされている必要がある
- Mac 間はローカルネットワーク（LAN / Wi-Fi）を通じて通信する
- 通信プロトコルとして Bonjour（mDNS）を使用してMac 間を自動検出する
- 切り替えコマンドを安全に送受信する

#### FR-013: Mac の自動検出
- 同一ネットワーク上の Magic Switch がインストールされた Mac を自動検出する
- 検出された Mac を接続先候補として表示する

---

## 3. 非機能要件

### 3.1 対応環境

#### NFR-001: 対応 OS
- **最小サポート**: macOS 13 Ventura 以降
- **推奨**: macOS 14 Sonoma 以降
- **対応アーキテクチャ**: Apple Silicon (arm64) および Intel (x86_64)

#### NFR-002: 対応デバイス
- Magic Keyboard（第1世代〜最新世代）
- Magic Keyboard with Touch ID
- Magic Keyboard with Touch ID and Numeric Keypad
- Magic Trackpad（第1世代〜最新世代）
- ※ Magic Mouse は将来的にサポート対象とする可能性がある（v1 ではスコープ外）

### 3.2 パフォーマンス

#### NFR-003: 切り替え時間
- デバイス1台の切り替え完了時間：**10秒以内**（ネットワーク遅延を含む）
- デバイス2台の同時切り替え完了時間：**15秒以内**
- ※ Bluetooth のペアリング/アンペアリング処理の特性上、数秒の遅延は避けられない

#### NFR-004: リソース使用量
- メモリ使用量：常駐時 **50MB 以下**
- CPU 使用率：アイドル時 **1% 以下**
- バックグラウンド通信によるバッテリー影響を最小化する

### 3.3 セキュリティ

#### NFR-005: 通信セキュリティ
- Mac 間の通信は暗号化する（TLS またはそれに準ずる方式）
- 認証されていない Mac からの切り替えリクエストを拒否する
- 初回接続時にペアリングコード等による相互認証を行う

#### NFR-006: データ保護
- 設定データ（デバイス MAC アドレス等）はローカルに安全に保存する
- 外部サーバーへのデータ送信は一切行わない
- クラウドサービスへの依存を排除する

### 3.4 信頼性

#### NFR-007: エラーハンドリング
- ネットワーク切断時は自動再接続を試行する
- 切り替え失敗時はリトライ機能を提供する（最大3回）
- 切り替え先の Mac が応答しない場合、タイムアウト（15秒）後にエラーを表示する

#### NFR-008: ログ出力
- 切り替え操作のログを記録する（デバッグ・トラブルシューティング用）
- ログファイルは `~/Library/Logs/MagicSwitch/` に保存する
- ログレベル（DEBUG / INFO / WARN / ERROR）を設定可能とする

---

## 4. 技術的制約事項

### 4.1 Apple Bluetooth の制約

#### TC-001: Magic デバイスのペアリング特性
Apple Magic Keyboard / Magic Trackpad は **一度にひとつの Mac としかペアリングできない**。通常の Bluetooth デバイスと異なり、マルチポイント接続には対応していない。そのため、切り替えには以下のプロセスが必要：

1. **現在の Mac 側**: デバイスのペアリングを解除（unpair）
2. **切り替え先の Mac 側**: デバイスを再ペアリング（pair）して接続

この一連の処理にはネットワーク経由での Mac 間連携が不可欠である。

#### TC-002: Bluetooth API の制限
- macOS の `IOBluetooth` フレームワークは公開 API としてペアリング/アンペアリングをサポートするが、**スレッドセーフではない**
- `CoreBluetooth` は BLE（Bluetooth Low Energy）向けであり、Classic Bluetooth を使用する Magic デバイスの制御には直接使用できない場合がある
- コマンドラインツール `blueutil` が実績のあるソリューションとして存在し、pair / unpair / connect / disconnect 操作が可能
- Apple のプライベート API に依存する場合、将来の macOS アップデートで動作しなくなるリスクがある

#### TC-003: 初回ペアリングの必要性
- 各 Mac で Magic デバイスの初回ペアリングは、ユーザーが手動で行う必要がある（システム設定 > Bluetooth、または Lightning/USB-C ケーブル接続）
- アプリケーションが初回ペアリングを完全に自動化することは困難である
- 初回ペアリング後、アプリ側でデバイスの MAC アドレスを記録し、以降の切り替えを自動化する

### 4.2 macOS 権限要件

#### TC-004: 必要な権限
アプリケーションは以下の macOS 権限を必要とする：

| 権限 | 用途 | TCC カテゴリ |
|------|------|-------------|
| Bluetooth | デバイスの検出・接続・切断 | `kTCCServiceBluetoothAlways` |
| Accessibility | グローバルキーボードショートカット | `kTCCServiceAccessibility` |
| Local Network | Mac 間通信 | `kTCCServiceLocalNetwork` |

- macOS 14 以降、Bluetooth アクセスは TCC（Transparency, Consent, and Control）による明示的な許可が必要
- `com.apple.security.device.bluetooth` エンタイトルメントが必要

#### TC-005: サンドボックスの制約
- App Sandbox 環境下では Bluetooth のペアリング/アンペアリング操作が制限される可能性がある
- Homebrew で配布するアプリケーションは App Store 経由ではないため、**サンドボックスは必須ではない**
- ただし、公証（Notarization）は必要であり、Hardened Runtime を有効にする必要がある

### 4.3 既知の技術的リスク

#### TC-006: blueutil の制限
- `blueutil` は一部の環境で Magic Keyboard のペアリングに失敗する報告がある（[GitHub Issue #93](https://github.com/toy/blueutil/issues/93)）
- `sudo` 権限が必要な操作がある可能性
- macOS のメジャーアップデートで動作しなくなるリスク

#### TC-007: Bluetooth 状態の不整合
- 切り替え中にネットワークが切断された場合、デバイスがどちらの Mac にも接続されていない状態が発生する可能性がある
- このような場合のリカバリ手順を提供する必要がある

---

## 5. ユーザーストーリー

### US-001: 業務用と個人用 Mac の切り替え
> **ユーザーとして**、業務用 MacBook Pro で作業中に、個人用 Mac mini に Magic Keyboard と Magic Trackpad を切り替えたい。
> **それにより**、ケーブルを繋ぎ直すことなく、メニューバーのクリックひとつで即座に個人用 Mac を操作できるようになる。

**受け入れ条件：**
- メニューバーから「個人用 Mac mini」を選択すると、Keyboard と Trackpad が同時に切り替わる
- 切り替え完了まで15秒以内
- 切り替え完了の通知が表示される

### US-002: キーボードショートカットでの高速切り替え
> **パワーユーザーとして**、キーボードショートカット（例：⌃⌥⌘2）で素早く接続先を切り替えたい。
> **それにより**、マウス操作なしで瞬時に別の Mac に切り替えられ、作業フローが中断されない。

**受け入れ条件：**
- カスタマイズ可能なグローバルショートカットが動作する
- ショートカット押下後、切り替えが自動的に開始される
- ※ Keyboard の切り替え中はショートカットが使えなくなるため、切り替え対象がKeyboard の場合はTrackpad またはメニューバーからの操作がフォールバックとなる

### US-003: 初回セットアップ
> **新規ユーザーとして**、アプリを初めて起動した際に、セットアップウィザードに従って簡単に初期設定を完了したい。
> **それにより**、技術的な知識がなくても、数ステップで切り替え環境を構築できる。

**受け入れ条件：**
- ウィザードが必要な権限の許可をガイドする
- ペアリング済みの Magic デバイスが自動検出される
- 接続先 Mac を登録できる（同一ネットワーク上の Mac を自動検出）

### US-004: バッテリー残量の確認
> **ユーザーとして**、Magic Keyboard と Magic Trackpad のバッテリー残量をメニューバーから確認したい。
> **それにより**、充電が必要なタイミングを事前に把握でき、作業中にデバイスが使えなくなる事態を防げる。

**受け入れ条件：**
- メニューバーのドロップダウンにバッテリー残量が%表示される
- 20% 以下で通知が表示される

### US-005: 切り替え失敗時のリカバリ
> **ユーザーとして**、切り替えに失敗した場合でも、元の Mac に戻すか手動で接続し直す方法を案内してほしい。
> **それにより**、デバイスが宙に浮いた状態（どちらの Mac にも接続されていない）を素早く解消できる。

**受け入れ条件：**
- エラー通知に「元の Mac に戻す」ボタンが表示される
- 手動接続のガイダンスが表示される（システム設定の Bluetooth を開くリンク等）

---

## 6. 制約事項と前提条件

### 6.1 前提条件
1. **すべての対象 Mac に Magic Switch がインストールされていること** — 切り替えには切り替え先の Mac 側でのペアリング操作が必要なため、両方の Mac にアプリが必要
2. **すべての対象 Mac が同一ローカルネットワークに接続されていること** — Mac 間通信に LAN / Wi-Fi を使用
3. **対象の Magic デバイスが各 Mac で一度は手動ペアリングされていること** — 初回ペアリングはユーザーが手動で実施
4. **macOS 13 Ventura 以降がインストールされていること**

### 6.2 制約事項
1. **インターネット経由の切り替えは非対応** — 同一ローカルネットワーク内での切り替えのみサポート
2. **Mac 以外のデバイスは非対応** — iPad、iPhone 等への切り替えはスコープ外
3. **Magic Mouse は v1 ではスコープ外** — 将来バージョンでの対応を検討
4. **Touch ID は切り替え先の Mac で使用不可** — Touch ID は初期ペアリング時の Mac にのみ紐付けられる Apple のセキュリティ制約
5. **切り替え中の入力は不可** — Keyboard の切り替え中（数秒間）はキー入力ができない
6. **管理者権限が必要な場合がある** — Bluetooth のペアリング/アンペアリング操作に sudo 権限が必要な場合がある

### 6.3 スコープ外（v1）
- Windows / Linux 対応
- iPad / iPhone への切り替え
- Magic Mouse 対応
- クラウド経由のリモート切り替え
- App Store での配布

---

## 7. Homebrew 配布要件

### 7.1 配布形態
- **Homebrew Cask** として配布する（GUIアプリケーションのため formula ではなく cask を使用）
- `brew install --cask magic-switch` でインストール可能にする

### 7.2 Cask 要件

#### HB-001: アプリケーションバンドル
- `.app` バンドル形式で配布する
- DMG または ZIP 形式でアーカイブする

#### HB-002: 署名と公証
- Apple Developer ID で**コード署名**（Code Signing）する
- Apple の**公証**（Notarization）を通す
- Hardened Runtime を有効にする
- これにより、Gatekeeper のブロックを回避し、ユーザーが安全にインストールできる

#### HB-003: Cask 定義
- homebrew-cask リポジトリに Cask 定義を提出するか、独自の Tap を作成する
- Cask 定義に以下を含める：
  - アプリケーション名
  - ダウンロード URL
  - SHA256 ハッシュ
  - アプリバンドルの配置先
  - アンインストール手順

#### HB-004: バージョン管理
- セマンティックバージョニング（SemVer）に従う
- アップデート時は Cask 定義のバージョンと SHA256 を更新する

### 7.3 インストール後の動作
- インストール後、初回起動時にセットアップウィザードが表示される
- Bluetooth、Accessibility、Local Network の権限許可をユーザーに求める
- ログイン時の自動起動設定を案内する

---

## 8. 用語集

| 用語 | 定義 |
|------|------|
| Magic Switch | 本アプリケーションの名称 |
| Magic Keyboard | Apple 製 Bluetooth ワイヤレスキーボード |
| Magic Trackpad | Apple 製 Bluetooth ワイヤレストラックパッド |
| ペアリング (Pairing) | Bluetooth デバイスと Mac を紐付ける操作 |
| アンペアリング (Unpairing) | Bluetooth デバイスと Mac の紐付けを解除する操作 |
| blueutil | macOS 用 Bluetooth CLI ツール |
| Bonjour | Apple のゼロコンフィギュレーションネットワーキング技術（mDNS） |
| TCC | Transparency, Consent, and Control — macOS のプライバシー制御フレームワーク |
| Cask | Homebrew の macOS GUI アプリ配布形態 |
| Hardened Runtime | macOS のセキュリティ強化機能。コード署名と公証に必要 |

---

## 改訂履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2026-02-23 | 1.0 | 初版作成 |
